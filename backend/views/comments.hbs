<!DOCTYPE html>
<html>
<head>
    <title>Bogobit</title>
    <link rel="stylesheet" href="/style.css">
    <link rel="icon" href="/images/favicon.png" type="image/x-icon">
</head>
<body data-total-comments="{{page.totalComments}}" data-current-page="{{page.currentPage}}">
    <h1>Comments</h1>
    {{> navbar}}

    <p id="comment-info"></p>
    <!-- Display all comments in an unordered list -->
    <ul class="comment-list">
        {{#each comments}}
            <li class="comment-entry" data-comment-id="{{id}}" data-user-vote="{{user_vote}}">
                <p>
                    <strong id="comment-author" style="color: #{{name_color}}">{{display_name}}</strong>
                    <div class="list-indent">
                        {{text}}<br>
                        <em class="comment-date">Posted on: {{created_at}}</em><br>
                        <!-- Voting -->
                        <div class="comment-vote-container">
                            <form action="/comment/vote" method="POST">
                                <input type="hidden" name="commentId" value="{{id}}">
                                <input type="hidden" name="vote" value="1">
                                <button type="submit" class="themed-button" data-vote="1">▲</button>
                            </form>

                            <form action="/comment/vote" method="POST">
                                <input type="hidden" name="commentId" value="{{id}}">
                                <input type="hidden" name="vote" value="-1">
                                <button type="submit" class="themed-button" data-vote="-1">▼</button>
                            </form>
                            <span class="comment-date">&nbsp;Points:&nbsp;{{points}}</span>
                        </div>
                    </div>
                </p>
            </li>
        {{/each}}
    </ul>

    <!-- If user is logged in, add comment form, else send to login -->
    {{#if user.isLoggedIn}}
        <form class="themed-form" id="add-comment" action="/comment/new" method="GET">
            <button class="themed-button" type="submit">Add Comment</button>
        </form>
    {{else}}
        <form class="themed-form" id="add-comment" action="/login" method="GET">
            <button class="themed-button" type="submit">Add Comment</button>
        </form>
    {{/if}}
    <br>
    <span class="pagination-container">
        <!-- Previous page -->
        {{#if page.prevPage}}
            <form action="/comments" method="GET">
                <input type="hidden" name="page" value="{{page.prevPage}}">
                <button class="themed-button" type="submit">&lt;</button>
            </form>
        {{/if}}

        <!-- Current Page -->
        <form action="/comments" method="GET">
            <input type="hidden" name="page" value="{{page.currentPage}}">
            <button class="selected-themed-button" type="submit">{{page.currentPage}}</button>
        </form>

        <!-- Display next five pages as quick buttons -->
        {{#if page.index}}
            {{#each page.index}}
                <form action="/comments" method="GET">
                    <input type="hidden" name="page" value="{{this}}">
                    <button class="page-button" type="submit">{{this}}</button>
                </form>
            {{/each}}
        {{/if}}
        
        <!-- Last Page -->
        {{#if page.lastPage}}
            ...
            <form action="/comments" method="GET">
                <input type="hidden" name="page" value="{{page.lastPage}}">
                <button class="page-button" type="submit">{{page.lastPage}}</button>
            </form>
        {{/if}}

        <!-- Next page -->
        {{#if page.nextPage}}
            <form action="/comments" method="GET">
                <input type="hidden" name="page" value="{{page.nextPage}}">
                <button class="themed-button" type="submit">&gt;</button>
            </form>
        {{/if}}
        &nbsp;&nbsp;&nbsp;
        <!-- Manual page number -->
        <form action="/comments" method="GET">
            <input type="number" id="manual-page" name="page" min="1" step="1" required>
            <button class="themed-button" type="submit">Go</button>
        </form>
    </span>

    {{> footer}}
    <script>
        // Before navigating away (form submit)
        document.querySelectorAll('form.vote-form').forEach(form => {
            form.addEventListener('submit', () => {
            localStorage.setItem('scrollPos', window.scrollY);
            });
        });

        // On page load, restore scroll
        window.addEventListener('load', () => {
            const scrollPos = localStorage.getItem('scrollPos');
            if (scrollPos) {
            window.scrollTo(0, parseInt(scrollPos, 10));
            localStorage.removeItem('scrollPos');
            }
        });

        document.querySelectorAll('.comment-entry').forEach(comment => {
            const vote = parseInt(comment.dataset.userVote) || 0;
            const upvoteButton = comment.querySelector('button[data-vote="1"]');
            const downvoteButton = comment.querySelector('button[data-vote="-1"]');

            if (vote === 1) {
                upvoteButton.style.color = "#1f1f29";
                upvoteButton.style.background = "#ffffff";
                downvoteButton.style.color = "";
                downvoteButton.style.background = "";
            } else if (vote === -1) {
                downvoteButton.style.color = "#1f1f29";
                downvoteButton.style.background = "#ffffff";
                upvoteButton.style.color = "";
                upvoteButton.style.background = "";
            } else {
                upvoteButton.style.color = "";
                upvoteButton.style.background = "";
                downvoteButton.style.color = "";
                downvoteButton.style.background = "";
            }
        });

        const PAGE_SIZE = 20;
        const totalComments = parseInt(document.body.dataset.totalComments, 10) || 0;
        const currentPage = parseInt(document.body.dataset.currentPage, 10) || 1;

        const commentInfo = document.getElementById("comment-info");
        if (totalComments === 0) {
            commentInfo.textContent = "No comments yet.";
        } else {
            const lowerCommentBound = (currentPage - 1) * PAGE_SIZE + 1;
            let upperCommentBound = currentPage * PAGE_SIZE;
            if (upperCommentBound > totalComments) upperCommentBound = totalComments;

            commentInfo.textContent = `Comments: ${lowerCommentBound}-${upperCommentBound} of ${totalComments}`;
        }
    </script>
</body>
</html>


