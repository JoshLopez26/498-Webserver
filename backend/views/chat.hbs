<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="/style.css">
    <link rel="icon" href="/images/favicon.png" type="image/x-icon">
    <title>Bogobit</title>
</head>
<body data-user-id="{{user.userId}}">
    <h1>Chatroom</h1>
    {{> navbar}}    
    <div class="chat-logs">
        <ul id="chat-log-entry">
            <!-- Display old chat messages here -->
            {{#each messages}}
                <li>
                    <p>
                        <strong id="message-author" style="color: #{{name_color}}">{{display_name}}</strong>
                        <div class="message-list-indent">
                            {{text}}<br>
                            <em class="message-date">Posted on: {{created_at}}</em><br>
                        </div>
                    </p>
                </li>
            {{/each}}
            <!-- Chat log entries will go here -->
        </ul>
    </div>

    <div>
        <h3>Add Message</h3>
        <!-- Simple input field and submit -->
        <label>Message:</label><br>
        <input type="text" name="chat_message" required>
        <button class="themed-button" id="send-chat-message" type="button">Send</button>
    </div>
    {{> footer}}
    <script src="https://cdn.socket.io/4.8.1/socket.io.min.js"></script>
    <script>
        const userId = document.body.dataset.userId;        
        let socket = null;


        function createComment(id, text, created_at, name, color)
        {
            // Create <li>
            const li = document.createElement('li');

            // Create <p>
            const p = document.createElement('p');

            // <strong id="message-author" style="color: #...">
            const strong = document.createElement('strong');
            strong.id = 'message-author';
            strong.textContent = name;
            strong.style.color = `#${color}`;

            // <div class="message-list-indent">
            const div = document.createElement('div');
            div.className = 'message-list-indent';

            // Add message text + <br>
            div.appendChild(document.createTextNode(text));
            div.appendChild(document.createElement('br'));

            // <em class="message-date">Posted on: ...</em>
            const em = document.createElement('em');
            em.className = 'message-date';
            em.textContent = `Posted on: ${created_at}`;
            div.appendChild(em);
            div.appendChild(document.createElement('br'));

            // Assemble <p> and <li>
            p.appendChild(strong);
            p.appendChild(div);
            li.appendChild(p);

            // Append to the chat log <ul>
            const chatLog = document.getElementById('chat-log-entry');
            chatLog.appendChild(li);

            // Auto-scroll to bottom
            chatLog.scrollTop = chatLog.scrollHeight;
        }

        function setupSocketHandlers() {
            if (socket)
            {
                socket.on('newChatMessage', (data) => {
                    createComment(data.id, data.text, data.created_at, data.display_name, data.name_color);
                });
            }
            else
            {
                alert('Socket.IO client is not initialized')
                console.error('Socket.IO client is not initialized.');
            }
        }

        document.addEventListener('DOMContentLoaded', (event) => {
            console.log('The DOM is fully loaded and parsed');
            socket = io('https://bogobit.org', {
                withCredentials: true
            });
            setupSocketHandlers();
        });

        document.getElementById('send-chat-message').addEventListener('click', () => {
            console.log('Sending chat message...');
            const message = document.querySelector('input[name="chat_message"]').value;
            socket.emit('getNewChatMessage', {
                user: userId,
                message: message
            });
            console.log('Chat message sent:', message);
        });
    </script>
</body>
</html>
